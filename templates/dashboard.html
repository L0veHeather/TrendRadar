{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>仪表盘</h2>
        <p class="text-muted">系统概览与控制</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card h-100 border-primary border-start border-4">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">运行模式</h6>
                <h3 class="card-title text-primary">{{ env.get('RUN_MODE', 'Unknown') }}</h3>
                <small class="text-muted">Cron: {{ env.get('CRON_SCHEDULE', '未设置') }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 border-success border-start border-4">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">通知状态</h6>
                <h3 class="card-title text-success">
                    {% if env.get('ENABLE_NOTIFICATION') == 'true' %}
                    已启用
                    {% else %}
                    未启用
                    {% endif %}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 border-info border-start border-4">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">今日输出</h6>
                <h3 class="card-title text-info">{{ today_files }}</h3>
                <small class="text-muted">份报告</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 border-warning border-start border-4">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">系统时间</h6>
                <h4 class="card-title text-dark" id="clock">00:00:00</h4>
                <small class="text-muted" id="date">YYYY-MM-DD</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">快速操作</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                    <button id="btn-run" class="btn btn-primary btn-lg">
                        <i class="fas fa-play"></i> 立即执行一次
                    </button>
                    <a href="/logs" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-list"></i> 查看日志
                    </a>
                </div>
                <div id="run-status" class="mt-3" style="display:none;">
                    <div class="alert alert-info">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        正在执行任务，请稍候... (可能需要几分钟)
                    </div>
                </div>
                <div id="run-result" class="mt-3"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">今日报告</h5>
            </div>
            <div class="list-group list-group-flush">
                {% if recent_reports %}
                {% for file in recent_reports %}
                <a href="/view/{{ file.path }}" target="_blank"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-file-alt text-secondary me-2"></i> {{ file.name }}</span>
                    <span class="badge bg-light text-dark">{{ file.time }}</span>
                </a>
                {% endfor %}
                {% else %}
                <div class="list-group-item text-center text-muted p-4">今日暂无报告</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">环境配置</h5>
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    爬虫功能
                    <span
                        class="badge {% if env.get('ENABLE_CRAWLER') == 'true' %}bg-success{% else %}bg-secondary{% endif %}">
                        {{ env.get('ENABLE_CRAWLER', 'false') }}
                    </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Web服务器
                    <span class="badge bg-success">Running</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    端口
                    <span class="badge bg-light text-dark">{{ port }}</span>
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateTime() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('date').innerText = now.toLocaleDateString('zh-CN');
    }
    setInterval(updateTime, 1000);
    updateTime();

    $('#btn-run').click(function () {
        if (confirm('确定要立即执行一次爬虫任务吗？')) {
            $(this).prop('disabled', true);
            $('#run-status').show();
            $('#run-result').html('');

            $.post('/api/run', function (data) {
                $('#run-status').hide();
                $('#btn-run').prop('disabled', false);

                if (data.success) {
                    $('#run-result').html('<div class="alert alert-success">✅ 执行成功！<br>' + data.message + '</div>');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    $('#run-result').html('<div class="alert alert-danger">❌ 执行失败: ' + data.message + '</div>');
                }
            }).fail(function () {
                $('#run-status').hide();
                $('#btn-run').prop('disabled', false);
                $('#run-result').html('<div class="alert alert-danger">❌ 请求失败，请检查服务器状态</div>');
            });
        }
    });
</script>
{% endblock %}